import { useState } from 'react';\nimport { useMutation, useQuery } from 'convex/react';\nimport { api } from '@/convex/_generated/api';\nimport { useNavigate, useSearchParams } from 'react-router-dom';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { motion } from 'framer-motion';\n\nexport default function PasswordReset() {\n  const navigate = useNavigate();\n  const [searchParams] = useSearchParams();\n  const token = searchParams.get('token');\n\n  const [step, setStep] = useState<'request' | 'verify' | 'reset'>(\n    token ? 'verify' : 'request'\n  );\n  const [email, setEmail] = useState('');\n  const [password, setPassword] = useState('');\n  const [confirmPassword, setConfirmPassword] = useState('');\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n  const [loading, setLoading] = useState(false);\n\n  const requestReset = useMutation(api.passwordReset.requestPasswordReset);\n  const verifyToken = useQuery(\n    api.passwordReset.verifyPasswordResetToken,\n    token ? { token } : 'skip'\n  );\n  const resetPassword = useMutation(api.passwordReset.resetPassword);\n\n  const handleRequestReset = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError('');\n    setLoading(true);\n\n    try {\n      if (!email) throw new Error('Please enter your email');\n      await requestReset({ email });\n      setSuccess('Password reset link sent to your email');\n      setEmail('');\n      setTimeout(() => setSuccess(''), 5000);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to request reset');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleResetPassword = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError('');\n    setLoading(true);\n\n    try {\n      if (!token) throw new Error('Reset token missing');\n      if (!password) throw new Error('Please enter a new password');\n      if (password.length < 8) throw new Error('Password must be at least 8 characters');\n      if (password !== confirmPassword) throw new Error('Passwords do not match');\n\n      await resetPassword({ token, newPassword: password });\n      setSuccess('Password reset successfully. Redirecting to login...');\n      setTimeout(() => navigate('/auth'), 2000);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to reset password');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 flex items-center justify-center p-4\">\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"w-full max-w-md\"\n      >\n        <div className=\"bg-white dark:bg-slate-800 rounded-lg shadow-lg p-8 border border-slate-200 dark:border-slate-700\">\n          <div className=\"text-center mb-8\">\n            <h1 className=\"text-3xl font-bold tracking-tight text-slate-900 dark:text-white mb-2\">\n              Reset Password\n            </h1>\n            <p className=\"text-slate-600 dark:text-slate-400\">\n              {token\n                ? 'Enter your new password'\n                : 'Forgot your password? No problem. We will help you reset it.'}\n            </p>\n          </div>\n\n          {/* Token Verification */}\n          {token && verifyToken && 'valid' in verifyToken && !verifyToken.valid && (\n            <div className=\"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6\">\n              <p className=\"text-red-800 dark:text-red-200 text-sm\">\n                {verifyToken.message || 'Invalid or expired reset link'}\n              </p>\n              <Button\n                onClick={() => navigate('/password-reset')}\n                variant=\"ghost\"\n                className=\"mt-4 w-full\"\n              >\n                Request a new reset link\n              </Button>\n            </div>\n          )}\n\n          {/* Error */}\n          {error && (\n            <div className=\"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6\">\n              <p className=\"text-red-800 dark:text-red-200 text-sm\">{error}</p>\n            </div>\n          )}\n\n          {/* Success */}\n          {success && (\n            <div className=\"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-6\">\n              <p className=\"text-green-800 dark:text-green-200 text-sm\">{success}</p>\n            </div>\n          )}\n\n          {/* Request Reset Form */}\n          {!token && step === 'request' && (\n            <form onSubmit={handleRequestReset} className=\"space-y-6\">\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                  Email Address\n                </label>\n                <Input\n                  type=\"email\"\n                  placeholder=\"your@email.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  disabled={loading}\n                  className=\"w-full\"\n                />\n              </div>\n              <Button type=\"submit\" disabled={loading} className=\"w-full\">\n                {loading ? 'Sending...' : 'Send Reset Link'}\n              </Button>\n            </form>\n          )}\n\n          {/* Reset Password Form */}\n          {token && verifyToken && 'valid' in verifyToken && verifyToken.valid && (\n            <form onSubmit={handleResetPassword} className=\"space-y-6\">\n              <div className=\"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4\">\n                <p className=\"text-blue-800 dark:text-blue-200 text-sm\">\n                  Welcome back, <strong>{verifyToken.userName}</strong>\n                </p>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                  New Password\n                </label>\n                <Input\n                  type=\"password\"\n                  placeholder=\"At least 8 characters\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  disabled={loading}\n                  className=\"w-full\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2\">\n                  Confirm Password\n                </label>\n                <Input\n                  type=\"password\"\n                  placeholder=\"Confirm your password\"\n                  value={confirmPassword}\n                  onChange={(e) => setConfirmPassword(e.target.value)}\n                  disabled={loading}\n                  className=\"w-full\"\n                />\n              </div>\n\n              <Button type=\"submit\" disabled={loading} className=\"w-full\">\n                {loading ? 'Resetting...' : 'Reset Password'}\n              </Button>\n            </form>\n          )}\n\n          {/* Back to Login Link */}\n          <div className=\"mt-8 text-center text-sm\">\n            <p className=\"text-slate-600 dark:text-slate-400\">\n              Remember your password?{' '}\n              <button\n                onClick={() => navigate('/auth')}\n                className=\"font-semibold text-slate-900 dark:text-white hover:underline cursor-pointer\"\n              >\n                Back to login\n              </button>\n            </p>\n          </div>\n        </div>\n      </motion.div>\n    </div>\n  );\n}\n"